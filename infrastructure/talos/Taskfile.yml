# https://taskfile.dev

version: '3'

tasks:
  default:
    cmds:
      - infisical run --env=prod --projectId=201b912b-40de-44bf-bb83-ab1bc77554b7 -- terraform apply -auto-approve
      - terraform output -raw kubeconfig > $KUBECONFIG
      - terraform output -raw talosconfig > $TALOSCONFIG
      - helmfile init
      - helmfile apply
      - cilium status --wait
      - |
        infisical run --env=prod --projectId=201b912b-40de-44bf-bb83-ab1bc77554b7 -- flux bootstrap github \
          --context=admin@hoopa \
          --owner=navaneeth-dev \
          --repository=fluxcd-homelab \
          --branch=main \
          --personal \
          --path=k8s/clusters/sp
    silent: true

  upgrade:
    - talosctl upgrade --preserve
    - talosctl upgrade-k8s
