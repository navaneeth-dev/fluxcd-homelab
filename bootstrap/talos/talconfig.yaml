# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
---
clusterName: home-cluster
talosVersion: "${talosVersion}"
kubernetesVersion: "${kubernetesVersion}"
endpoint: https://192.168.3.200:6443
allowSchedulingOnControlPlanes: true
additionalMachineCertSans:
  - 192.168.3.2
  - 192.168.3.3
  - 192.168.3.4
additionalApiServerCertSans:
  - 192.168.3.200
clusterPodNets:
  - 10.244.0.0/16
clusterSvcNets:
  - 10.96.0.0/12
cniConfig:
  name: none
nodes:
  - hostname: controlplane-deepcool
    ipAddress: 192.168.3.2
    controlPlane: true
    installDiskSelector:
      type: "nvme"
    networkInterfaces:
      - interface: enp3s0
        dhcp: false
        vip:
          ip: 192.168.3.200
        vlans:
          - vlanId: 2
            addresses:
              - 192.168.3.2/24
            routes:
              - network: 0.0.0.0/0
                gateway: 192.168.3.1
  - hostname: controlplane-dell
    ipAddress: 192.168.3.3
    controlPlane: true
    installDiskSelector:
      type: "nvme"
    networkInterfaces:
      - interface: eno1
        dhcp: false
        vlans:
          - vlanId: 2
            dhcp: false
            vip:
              ip: 192.168.3.200
            addresses:
              - 192.168.3.3/24
            routes:
              - network: 0.0.0.0/0
                gateway: 192.168.3.1
  - hostname: controlplane-thinkcentre
    ipAddress: 192.168.3.4
    controlPlane: true
    installDiskSelector:
      type: "nvme"
    networkInterfaces:
      - interface: enp2s0
        dhcp: false
        vip:
          ip: 192.168.3.200
        vlans:
          - vlanId: 2
            addresses:
              - 192.168.3.4/24
            routes:
              - network: 0.0.0.0/0
                gateway: 192.168.3.1
controlPlane:
  machineSpec:
    mode: metal
  nameservers:
    - 192.168.3.1
  schematic:
    customization:
      systemExtensions:
        officialExtensions:
          - siderolabs/drbd
          - siderolabs/i915
          - siderolabs/intel-ucode

patches:
  - |
    machine:
      kubelet:
        extraArgs:
          rotate-server-certificates: true
    cluster:
      extraManifests:
        - https://raw.githubusercontent.com/alex1989hu/kubelet-serving-cert-approver/main/deploy/standalone-install.yaml
        - https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

  - |
    machine:
      nodeLabels:
        intel.feature.node.kubernetes.io/gpu: "true"

  - |-
    cluster:
      proxy:
        disabled: true

  - &hostDNS |
    machine:
      features:
        hostDNS:
          enabled: true
          resolveMemberNames: true
          forwardKubeDNSToHost: false

  - |-
    machine:
      kernel:
        modules:
          - name: drbd
            parameters:
              - usermode_helper=disabled
          - name: drbd_transport_tcp
          - name: dm-thin-pool

  - |-
    apiVersion: v1alpha1
    kind: VolumeConfig
    name: EPHEMERAL
    provisioning:
      maxSize: 200GiB
      grow: false

  - |-
    apiVersion: v1alpha1
    kind: RawVolumeConfig
    name: csi-data
    provisioning:
      diskSelector:
        match: system_disk
      minSize: 200GiB
      maxSize: 200GiB
